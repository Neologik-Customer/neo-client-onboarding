name: Sync to Customer Repository

on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # Also triggers on manual version tags
  workflow_dispatch:  # Allows manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for proper sync
      
      - name: Check for release in commit message
        id: check_release
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"
          
          # Check if commit message contains "release" and a version (e.g., v1.2.3, 1.2.3)
          if echo "$COMMIT_MSG" | grep -iE "release.*v?[0-9]+\.[0-9]+\.[0-9]+"; then
            # Extract version number
            VERSION=$(echo "$COMMIT_MSG" | grep -oE "v?[0-9]+\.[0-9]+\.[0-9]+" | head -1)
            
            # Ensure version starts with 'v'
            if [[ ! $VERSION == v* ]]; then
              VERSION="v$VERSION"
            fi
            
            echo "Release detected! Version: $VERSION"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "No release detected in commit message"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create and push tag
        if: steps.check_release.outputs.should_release == 'true' && !startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION="${{ steps.check_release.outputs.version }}"
          
          # Check if tag already exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists, skipping tag creation"
          else
            echo "Creating tag $VERSION"
            git tag "$VERSION"
            git push origin "$VERSION"
          fi
          
      - name: Push to customer repository
        if: steps.check_release.outputs.should_release == 'true' || startsWith(github.ref, 'refs/tags/')
        env:
          CUSTOMER_REPO_TOKEN: ${{ secrets.CUSTOMER_REPO_TOKEN }}
        run: |
          # Debug: Check if token is available (without exposing it)
          if [ -z "$CUSTOMER_REPO_TOKEN" ]; then
            echo "ERROR: CUSTOMER_REPO_TOKEN secret is not set or is empty"
            exit 1
          fi
          echo "Token is available (length: ${#CUSTOMER_REPO_TOKEN})"
          
          # Configure git to use the token
          git config --global url."https://x-access-token:${CUSTOMER_REPO_TOKEN}@github.com/".insteadOf "https://github.com/"
          
          git remote add customer https://github.com/Neologik-Customer/neo-client-onboarding.git || git remote set-url customer https://github.com/Neologik-Customer/neo-client-onboarding.git
          git push customer main --force
          git push customer --tags
